---
title: "Le projet R forces"
author:  - "Méziane Cherif"
  - "Olivier Cailloux"
output: pdf_document
---

# Contexte
Commission d’enquête de l’AN
la situation, les missions et les moyens des forces de sécurité
22 mai au 28 juin 2019
agents de la police nationale et des polices municipales, aux militaires de la gendarmerie nationale et aux réservistes

"les éléments des réponses permettant d’identifier le répondant (coordonnées ou risque de ré-identification) ainsi que les réponses comprenant des imputations personnelles ou des insultes ont été supprimés."

https://data.assemblee-nationale.fr/autres/consultations-citoyennes/moyens-des-forces-de-securite

Nous utilisons également les « Principaux indicateurs sur les revenus et la pauvreté aux niveaux national et local en 2019 » du dispositif Fichier localisé social et fiscal (Filosofi) publié par l’INSEE (présentation [ici](https://www.insee.fr/fr/statistiques/6436484), téléchargement [ici](https://www.insee.fr/fr/statistiques/6036902)). Des données plus récentes [existent](https://www.insee.fr/fr/statistiques/7752770) mais nous utilisons les données reflétant la réalité au moment des réponses des forces de sécurité.

# Mise en place
Chargeons quelques packages utiles.
```{r, message=FALSE}
library(conflicted)
conflicts_prefer(dplyr::filter)
library(tidyverse)
```

Téléchargeons les réponses des forces de sécurité, ou vérifions leur conformité si elles sont déjà présentes à l’aide du hash MD5 indiqué sur le site sus-mentionné.
```{r}
answers_url <- paste0(
  "https://data.assemblee-nationale.fr/",
  "static/openData/repository/CONSULTATIONS_CITOYENNES/",
  "MOYENS_DES_FORCES_DE_SECURITE/Moyens-des-forces-de-securite.csv"
)
md5_expected <- "261b4244cc2e9ffcd54ff9a6bec0a0ac"
if (file.exists("Réponses original.csv")) {
  md5_observed <- tools::md5sum("Réponses original.csv")
} else {
  md5_observed <- 0L
}
if (md5_observed != md5_expected) {
  downloaded_return <- download.file(answers_url, "Réponses original.csv", mode = "wb")
  stopifnot(identical(downloaded_return, 0L))
}
md5_observed <- tools::md5sum("Réponses original.csv")
stopifnot(md5_observed == md5_expected)
```
Convertissons en UTF8.
```{r}
input_original <- readLines("Réponses original.csv")
input_converted <- iconv(input_original, from = "WINDOWS-1252", to = "UTF8")
writeLines(input_converted, "Réponses.csv")
```

Téléchargeons de même les données sur les revenus et la pauvreté.
```{r}
zip_file_name <- "base-cc-filosofi-2019_CSV.zip"
filosofi_url <- paste0("https://www.insee.fr/fr/statistiques/fichier/6036902/", zip_file_name)
if (!file.exists(zip_file_name)) {
  downloaded_return <- download.file(filosofi_url, zip_file_name, mode = "wb")
  stopifnot(identical(downloaded_return, 0L))
}

to_extract <- c("cc_filosofi_2019_DEP.csv", "meta_cc_filosofi_2019_DEP.csv")
if (!all(file.exists(to_extract))) {
  unzip(zip_file_name, files = to_extract)
}
```

# Lecture des données
## Réponses
Lisons les réponses des forces de sécurité.
```{r}
answers <- read_delim("Réponses.csv",
  delim = ";", locale = locale(decimal_mark = ","),
  show_col_types = FALSE, name_repair = "minimal"
)
col_renaming <- read_csv("Colonnes.csv", show_col_types = FALSE)
stopifnot(all.equal(colnames(answers), col_renaming[["Nom original"]]))
colnames(answers) <- col_renaming[["Nouveau nom"]]
answers
```

Vérifions que les décimales sont lues correctement et que nous disposons du nombre de contributions annoncé sur le site ministériel.
```{r}
stopifnot(answers |> filter(rep == 9) |> pull(train_days_2017) == 2.5)
stopifnot(nrow(answers) == 13735)
```

## Revenus et pauvreté
Lisons maintenant les données économiques.
```{r}
revenues_poverty <- read_delim("cc_filosofi_2019_DEP.csv",
  delim = ";", locale = locale(decimal_mark = ","),
  show_col_types = FALSE
)
revenues_poverty
```

Vérifions que le revenu médian et le taux de pauvreté de l’Ain sont ceux indiqués [sur le site](https://www.insee.fr/fr/statistiques/6436484?sommaire=6036904#tableau-figure1_radio1).
```{r}
ain <- revenues_poverty |> filter(CODGEO == "01")
stopifnot(ain |> pull(MED19) == 23490)
stopifnot(ain |> pull(TP6019) == 10.7)
```

# Traitement des données
Extrayons le premier mot de la colonne `dept` pour obtenir le code de département (on vérifie avec une réponse donnée que la conversion a fonctionné).
Notons que les départements corses ne s’encodent pas comme des nombres, donc ce code doit être de type chaine de caractères.

Transformons également l’âge donné en nombre entier.

```{r}
stopifnot(answers |> filter(rep == 3) |> pull(dept) == "08 - ARDENNES")
answers <- mutate(answers, dept_nb = str_extract(dept, "^[0-9AB]+"), .after = dept)
stopifnot(answers |> filter(rep == 3) |> pull(dept_nb) == "08")

answers <- answers |> filter(!is.na(agemaj)) |> filter(agemaj != "Autre")
stopifnot(all(str_detect(answers$agemaj, "^[0-9]+ ans$")))
answers <- mutate(answers, agemaj = as.integer(str_extract(agemaj, "^[0-9]+")))
```

# Croisement des données
Nous pouvons maintenant joindre les données économiques aux réponses des forces de sécurité.
```{r}
data <- left_join(answers, revenues_poverty, by = c("dept_nb" = "CODGEO"))
data
write_csv(data, "Données fusionnées.csv", na = "")
```

# Idées (brouillon)
Nous pourrions analyser le lien entre la pauvreté du lieu d’exercice et l’âge souhaité des mineurs (surtout pauvreté des plus jeunes) ; le manque d’effectif ; le temps de formation ; le nombre de jours supplémentaires impayés et le manque d’effectif ; l’appréciation de la mobilité ; la volonté d’un cadre plus sûr ; la forfaitisation de sanctions…

# Sélection
Considérons le taux de pauvreté dans leur département et l’âge souhaité pour traitement comme un majeur. On ne retient en outre que les enregistrements où ces deux variables sont renseignées.

```{r}
subset <- data |> select("TP6019", "agemaj") |> drop_na()
```
# Décrire les variables retenues
# Variable: Age de la majorité (agemaj)
agemaj <- data$agemaj

# Tableau de fréquences pour l'âge de la majorité
table_agemaj <- table(agemaj)
print(table_agemaj)

# Diagramme en barres pour l'âge de la majorité
barplot(table_agemaj, main = "Distribution de l'âge de la majorité", xlab = "Âge", ylab = "Fréquence", col = "lightblue")

# Variable: Revenu disponible (revenu_disponible)
# Histogramme pour le revenu disponible
hist(revenu_disponible, main = "Distribution du revenu disponible", xlab = "Revenu disponible", ylab = "Fréquence", col = "lightgreen", breaks = 20)

# Variable: Catégorie (policier ou armée)
categorie <- data$categorie

# Supprimer les valeurs manquantes dans categorie
categorie <- categorie[!is.na(categorie)]
categorie <- as.factor(categorie)  # Assurez-vous que la variable est un facteur

# Tableau de fréquences pour la catégorie
table_categorie <- table(categorie)
print(table_categorie) 

# Vérifier s'il y a au moins deux catégories pour éviter les erreurs dans le graphique
if (length(table_categorie) >= 2) {
  # Diagramme en secteurs pour la catégorie
  pie(table_categorie, main = "Répartition des catégories (policier ou armée)", col = c("lightcoral", "lightyellow"))
} else {
  cat("Impossible de créer un diagramme en secteurs : moins de deux catégories présentes.\n")



#estimation de l'age moyen requis pour être considéré comme un majeur 


x<-mean(subset$agemaj)
x

scor <- sd(subset$agemaj)
scor
n<-length(subset$agemaj)
n

a1 <- x - qnorm(0.975)*(scor/sqrt(n))
a2 <- x + qnorm(0.975)*(scor/sqrt(n))
c(a1,a2)

b1 <- x - qnorm(0.95)*(scor/sqrt(n))
b2 <- x + qnorm(0.95)*(scor/sqrt(n))
c(b1,b2)



revenu_disponible <- data$RD19  

mu_0 <- 3.5 

t_test_5 <- t.test(revenu_disponible, mu = mu_0, conf.level = 0.95)

print(t_test_5)

if (t_test_5$p.value < 0.05) {
  cat("Au seuil de 5%, nous rejetons l'hypothèse nulle : la moyenne du revenu disponible est significativement différente de 3.5.\n")
} else {
  cat("Au seuil de 5%, nous ne pouvons pas rejeter l'hypothèse nulle : la moyenne du revenu disponible n'est pas significativement différente de 3.5.\n")
}

t_test_10 <- t.test(revenu_disponible, mu = mu_0, conf.level = 0.90)

print(t_test_10)

# Commentaire sur le résultat au seuil de 10%
if (t_test_10$p.value < 0.10) {
  cat("Au seuil de 10%, nous rejetons l'hypothèse nulle : la moyenne du revenu disponible est significativement différente de 3.5.\n")
} else {
  cat("Au seuil de 10%, nous ne pouvons pas rejeter l'hypothèse nulle : la moyenne du revenu disponible n'est pas significativement différente de 3.5.\n")
}



